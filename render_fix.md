# اصلاحات برای Render.com

## مشکلاتی که حل شد:

### 1. **مشکل حافظه (Memory/OOM)**
- دانلود ویدیوها به صورت async و non-blocking تغییر کرد
- محدودیت حجم فایل قبل از دانلود اضافه شد
- کیفیت ویدیو بر اساس محدودیت حجم کاهش یافت
- پاکسازی خودکار فایل‌های قدیمی و ناتمام
- **محدودیت حجم برای دانلود مستقیم** اعمال شد

### 2. **مشکل Blocking**
- دانلود yt-dlp به executor منتقل شد تا event loop بلاک نشود
- **دانلود فایل‌های مستقیم** نیز به executor منتقل شد
- timeout برای همه عملیات دانلود اضافه شد (10 دقیقه yt-dlp، 5 دقیقه فایل مستقیم)

### 3. **مدیریت دیسک**
- پاکسازی فایل‌های قدیمی‌تر از 1 ساعت
- حذف فایل‌های ناتمام (.part, .ytdl, .temp)
- پاکسازی در استارت و قبل از هر دانلود

### 4. **مدیریت خطا**
- پیام‌های خطای کاربرپسند برای OOM، Timeout، و Connection
- cleanup در تمام حالات خطا

## تنظیمات محیطی جدید:

```bash
MAX_FILE_SIZE_MB=500  # محدودیت حجم فایل (پیشنهاد: 300-500 برای Render Free)
```

## توصیه‌ها برای Render.com:

1. **Free Tier**: `MAX_FILE_SIZE_MB=300`
2. **Starter Tier**: `MAX_FILE_SIZE_MB=500`
3. **Pro Tier**: `MAX_FILE_SIZE_MB=1000`

## سایت‌های پشتیبانی شده:
- ✅ porn300.com (با کیفیت بهینه)
- ✅ xgroovy.com (با کیفیت بهینه)
- ✅ 1000+ سایت دیگر

## نکات مهم:
- اگر ربات ری‌استارت شد، محدودیت حجم را کمتر کنید
- فایل‌های موقت به صورت خودکار پاک می‌شوند
- دانلودها non-blocking هستند و ربات پاسخگو می‌ماند
